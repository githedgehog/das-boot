# OVMF Notes

## Dealing with UEFI variables and Secure Boot from the host

Somebody has finally written a tool in 2022 for being able to deal with this from outside of a VM (https://gitlab.com/kraxel/virt-firmware).
Now enrolling keys is as easy as this (and it does not even use "Custom Mode" which is perfect for our testing):

```shell
virt-fw-vars --enroll-generate PK --secure-boot --input OVMF_VARS.fd --output OVMF_VARS.fd --add-db  77fa9abd-0359-4d32-bd60-28f4e78f784b ~/microsoft-uefi-test-ca/hedgehog-microsoft-ca.der
```

### Detecting Secure Boot errors

On an OVMF debug image or port (or serial port if that is enabled in OVMF) one will see the following output when secure boot is enabled but the shim isn't signed with the right key:

```console
[Bds]Booting ONIE: Open Network Install Environment
FSOpen: Open '\EFI\onie\shimx64.efi' Success
[Bds] Expand PciRoot(0x0)/Pci(0x4,0x0)/HD(1,GPT,D25CF3C1-6644-4B0C-9F2C-8CFD2F4E58C3,0x800,0x80000)/\EFI\onie\shimx64.efi -> PciRoot(0x0)/Pci(0x4,0x0)/HD(1,
GPT,D25CF3C1-6644-4B0C-9F2C-8CFD2F4E58C3,0x800,0x80000)/\EFI\onie\shimx64.efi
[Security] 3rd party image[0] can be loaded after EndOfDxe: PciRoot(0x0)/Pci(0x4,0x0)/HD(1,GPT,D25CF3C1-6644-4B0C-9F2C-8CFD2F4E58C3,0x800,0x80000)/\EFI\onie
\shimx64.efi.
DxeImageVerificationLib: Image is signed but signature is not allowed by DB and SHA256 hash of image is not found in DB/DBX.
The image doesn't pass verification: PciRoot(0x0)/Pci(0x4,0x0)/HD(1,GPT,D25CF3C1-6644-4B0C-9F2C-8CFD2F4E58C3,0x800,0x80000)/\EFI\onie\shimx64.efi
```

Add the following to your QEMU command line for the debug port:

```shell
-debugcon file:ovmf-debug.log -global isa-debugcon.iobase=0x402
```

## Building OVM for customizations

```shell
# clone EDK II sources - don't forget the submodules
git clone https://github.com/tianocore/edk2
cd edk2
git submodule update --init --recursive

# EDK II is FINALLY simple to build by now by using their docker images, choose your poison here
docker pull ghcr.io/tianocore/containers/ubuntu-22-dev:latest
docker pull ghcr.io/tianocore/containers/fedora-37-dev:latest

# one of the following depending on your flavour
docker run -ti -v /home/mheese/git/edk2:/src/edk2 --workdir=/src/edk2 --name=edk2-dev ghcr.io/tianocore/containers/fedora-37-dev:latest /bin/bash
docker run -ti -v /home/mheese/git/edk2:/src/edk2 --workdir=/src/edk2 --name=edk2-dev ghcr.io/tianocore/containers/ubuntu-22-dev:latest /bin/bash

# get back into the same container with
# (yes, you have never used Docker before --> I'm your teacher)
docker start -ai edk2-dev

# one time step: make the base tools
make -C BaseTools

# after that you can build OVMF with the following command below (pick your build flags how you like them)
./OvmfPkg/build.sh -a X64 -D SECURE_BOOT_ENABLE -D SMM_REQUIRE -D TPM2_ENABLE -D DEBUG_ON_SERIAL_PORT=FALSE -D NETWORK_TLS_ENABLE -D NETWORK_IP6_ENABLE -D NETWORK_HTTP_BOOT_ENABLE
```

The following patch enrolls another default "Microsoft" certificate to the "db" certificates.
This allows to test real secure boot by signing the shim with this "Microsoft" cert and putting the UEFI firmware into standard "User Mode".

```patch
diff --git a/OvmfPkg/EnrollDefaultKeys/AuthData.c b/OvmfPkg/EnrollDefaultKeys/AuthData.c
index 53ee7f7003..688057d8d0 100644
--- a/OvmfPkg/EnrollDefaultKeys/AuthData.c
+++ b/OvmfPkg/EnrollDefaultKeys/AuthData.c
@@ -395,6 +395,92 @@ CONST UINT8  mMicrosoftUefiCa[] = {
 
 CONST UINTN  mSizeOfMicrosoftUefiCa = sizeof mMicrosoftUefiCa;
 
+CONST UINT8  mHedgehogMicrosoftUefiCa[] = {
+  0x30, 0x82, 0x03, 0xba, 0x30, 0x82, 0x02, 0xa2, 0xa0, 0x03, 0x02, 0x01,
+  0x02, 0x02, 0x14, 0x03, 0x46, 0x6e, 0x1a, 0x64, 0x19, 0x4d, 0x1f, 0x07,
+  0x01, 0x11, 0x05, 0xd6, 0x34, 0xe2, 0x6a, 0x75, 0x92, 0xf9, 0xb7, 0x30,
+  0x0d, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b,
+  0x05, 0x00, 0x30, 0x6e, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04,
+  0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55,
+  0x04, 0x08, 0x0c, 0x08, 0x44, 0x65, 0x6c, 0x61, 0x77, 0x61, 0x72, 0x65,
+  0x31, 0x22, 0x30, 0x20, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x19, 0x48,
+  0x65, 0x64, 0x67, 0x65, 0x68, 0x6f, 0x67, 0x20, 0x53, 0x4f, 0x4e, 0x69,
+  0x43, 0x20, 0x46, 0x6f, 0x75, 0x6e, 0x64, 0x61, 0x74, 0x69, 0x6f, 0x6e,
+  0x31, 0x28, 0x30, 0x26, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x1f, 0x48,
+  0x65, 0x64, 0x67, 0x65, 0x68, 0x6f, 0x67, 0x20, 0x4d, 0x69, 0x63, 0x72,
+  0x6f, 0x73, 0x6f, 0x66, 0x74, 0x20, 0x55, 0x45, 0x46, 0x49, 0x20, 0x54,
+  0x45, 0x53, 0x54, 0x20, 0x43, 0x41, 0x30, 0x1e, 0x17, 0x0d, 0x32, 0x33,
+  0x30, 0x34, 0x31, 0x33, 0x30, 0x36, 0x32, 0x33, 0x32, 0x37, 0x5a, 0x17,
+  0x0d, 0x33, 0x33, 0x30, 0x32, 0x31, 0x39, 0x30, 0x36, 0x32, 0x33, 0x32,
+  0x37, 0x5a, 0x30, 0x6e, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04,
+  0x06, 0x13, 0x02, 0x55, 0x53, 0x31, 0x11, 0x30, 0x0f, 0x06, 0x03, 0x55,
+  0x04, 0x08, 0x0c, 0x08, 0x44, 0x65, 0x6c, 0x61, 0x77, 0x61, 0x72, 0x65,
+  0x31, 0x22, 0x30, 0x20, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x19, 0x48,
+  0x65, 0x64, 0x67, 0x65, 0x68, 0x6f, 0x67, 0x20, 0x53, 0x4f, 0x4e, 0x69,
+  0x43, 0x20, 0x46, 0x6f, 0x75, 0x6e, 0x64, 0x61, 0x74, 0x69, 0x6f, 0x6e,
+  0x31, 0x28, 0x30, 0x26, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x1f, 0x48,
+  0x65, 0x64, 0x67, 0x65, 0x68, 0x6f, 0x67, 0x20, 0x4d, 0x69, 0x63, 0x72,
+  0x6f, 0x73, 0x6f, 0x66, 0x74, 0x20, 0x55, 0x45, 0x46, 0x49, 0x20, 0x54,
+  0x45, 0x53, 0x54, 0x20, 0x43, 0x41, 0x30, 0x82, 0x01, 0x22, 0x30, 0x0d,
+  0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x01, 0x05,
+  0x00, 0x03, 0x82, 0x01, 0x0f, 0x00, 0x30, 0x82, 0x01, 0x0a, 0x02, 0x82,
+  0x01, 0x01, 0x00, 0xa9, 0x6f, 0xe8, 0x12, 0x76, 0x3d, 0x6f, 0xa5, 0xd5,
+  0x11, 0x62, 0x98, 0x39, 0x34, 0xe8, 0x5a, 0xea, 0xf8, 0x77, 0xdc, 0xfc,
+  0x8d, 0xea, 0x52, 0x6d, 0x5a, 0x6d, 0xed, 0x65, 0x5b, 0xa5, 0x69, 0xff,
+  0xbb, 0xbc, 0xd5, 0x2c, 0x7d, 0x91, 0xda, 0x9d, 0x17, 0xe0, 0xdf, 0xf7,
+  0x02, 0xcd, 0x1a, 0x6c, 0x69, 0x41, 0xf5, 0x2c, 0x8c, 0x22, 0x01, 0xd1,
+  0x47, 0x21, 0xe8, 0x07, 0x41, 0x53, 0x4e, 0x6a, 0x21, 0x7b, 0xa2, 0x70,
+  0x03, 0x49, 0x9a, 0xf7, 0x8c, 0x79, 0x93, 0x6c, 0xdd, 0x00, 0x8f, 0xb2,
+  0x2e, 0x65, 0x65, 0xdc, 0x34, 0x3c, 0xd3, 0x66, 0x12, 0x1f, 0x3c, 0x31,
+  0x2b, 0xb2, 0xfd, 0xcf, 0x28, 0x50, 0x7b, 0xc3, 0x60, 0xa4, 0x54, 0x8f,
+  0xc5, 0xbf, 0x15, 0x50, 0xff, 0x1c, 0xb1, 0x74, 0x90, 0x8b, 0x9e, 0x04,
+  0x12, 0x98, 0x22, 0x91, 0x22, 0x7f, 0xd5, 0x33, 0x33, 0x4a, 0xdb, 0x28,
+  0x74, 0x94, 0x00, 0x60, 0x1a, 0x21, 0x41, 0xee, 0x08, 0x48, 0x50, 0x68,
+  0x14, 0x9b, 0x55, 0xe5, 0x82, 0x71, 0xc2, 0x14, 0xf0, 0xc0, 0x83, 0xc2,
+  0x72, 0xaa, 0xaa, 0x84, 0x41, 0x1b, 0xfc, 0xd0, 0x35, 0xef, 0xba, 0x77,
+  0x50, 0x23, 0xfd, 0x20, 0xda, 0x74, 0x63, 0x9f, 0x74, 0x6c, 0x9c, 0xad,
+  0x63, 0xf0, 0x0c, 0x97, 0x92, 0x4b, 0x71, 0x2c, 0x08, 0x4b, 0x38, 0x11,
+  0x29, 0x1b, 0x89, 0x6a, 0xa7, 0xb9, 0xb7, 0xcd, 0x94, 0x4c, 0x3c, 0xe4,
+  0xc7, 0x0c, 0xca, 0xe5, 0x6c, 0x5e, 0xcf, 0x32, 0xa8, 0xbf, 0xc6, 0x27,
+  0x23, 0x70, 0xa8, 0x9d, 0xa9, 0x2e, 0x63, 0x6c, 0x3b, 0xbd, 0xf3, 0x8e,
+  0xbf, 0xf0, 0xd6, 0xba, 0x20, 0xfd, 0x51, 0xb5, 0xa1, 0xd1, 0xa2, 0xff,
+  0xd5, 0x75, 0xc7, 0x87, 0x61, 0xe9, 0x75, 0x80, 0x96, 0x6d, 0xe3, 0xe1,
+  0x3b, 0x09, 0x83, 0x31, 0x9a, 0xc7, 0x17, 0x02, 0x03, 0x01, 0x00, 0x01,
+  0xa3, 0x50, 0x30, 0x4e, 0x30, 0x0c, 0x06, 0x03, 0x55, 0x1d, 0x13, 0x04,
+  0x05, 0x30, 0x03, 0x01, 0x01, 0xff, 0x30, 0x1d, 0x06, 0x03, 0x55, 0x1d,
+  0x0e, 0x04, 0x16, 0x04, 0x14, 0x3a, 0x79, 0x49, 0x10, 0x04, 0x57, 0x82,
+  0x18, 0x77, 0xb4, 0x92, 0x63, 0xa0, 0xf7, 0xe7, 0x3b, 0xb5, 0x68, 0x00,
+  0xb5, 0x30, 0x1f, 0x06, 0x03, 0x55, 0x1d, 0x23, 0x04, 0x18, 0x30, 0x16,
+  0x80, 0x14, 0x3a, 0x79, 0x49, 0x10, 0x04, 0x57, 0x82, 0x18, 0x77, 0xb4,
+  0x92, 0x63, 0xa0, 0xf7, 0xe7, 0x3b, 0xb5, 0x68, 0x00, 0xb5, 0x30, 0x0d,
+  0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x01, 0x0b, 0x05,
+  0x00, 0x03, 0x82, 0x01, 0x01, 0x00, 0x62, 0x85, 0x8d, 0x26, 0xf9, 0x91,
+  0x4f, 0x19, 0xb9, 0xd3, 0x91, 0xf1, 0x38, 0xa6, 0x93, 0xa1, 0xe3, 0x8f,
+  0xa9, 0xe8, 0x80, 0x17, 0xc2, 0x57, 0x74, 0x85, 0x48, 0x90, 0xa1, 0xc6,
+  0xe7, 0xca, 0x27, 0xa2, 0xcc, 0xfd, 0xa2, 0x7d, 0x89, 0x05, 0x4d, 0xf4,
+  0x21, 0xa1, 0xce, 0x71, 0xac, 0x66, 0x7a, 0xbd, 0x10, 0xa2, 0x34, 0xd1,
+  0xec, 0x94, 0xd9, 0xe6, 0x15, 0xb9, 0x65, 0x10, 0xef, 0x23, 0x7c, 0x9b,
+  0x7b, 0x97, 0xc6, 0x5a, 0x79, 0x42, 0x6d, 0xad, 0x17, 0x2e, 0x07, 0xc1,
+  0xba, 0xc6, 0xd1, 0x39, 0x15, 0xcb, 0x4d, 0x7b, 0x56, 0xa8, 0x67, 0xb2,
+  0x63, 0x23, 0xdc, 0x58, 0x62, 0xa7, 0xd2, 0xa3, 0x29, 0x8b, 0xb9, 0x4f,
+  0xcc, 0xb8, 0xf4, 0x78, 0xfd, 0x54, 0x1e, 0xa2, 0x51, 0x71, 0xe5, 0x59,
+  0x7f, 0xe9, 0x37, 0xa0, 0xec, 0x07, 0x0b, 0xd6, 0xec, 0xd8, 0x56, 0xb9,
+  0x2c, 0xe8, 0xe7, 0xba, 0x17, 0xc6, 0x01, 0x06, 0x84, 0x3c, 0x56, 0x8e,
+  0x64, 0x4a, 0xe0, 0x72, 0xfe, 0x82, 0x37, 0xbc, 0xb2, 0x38, 0x46, 0xc8,
+  0xe8, 0x2c, 0xf9, 0xaa, 0x8e, 0xa9, 0xdf, 0x54, 0x71, 0x6f, 0x0e, 0xa7,
+  0x4e, 0xdd, 0x35, 0x94, 0xf7, 0x6e, 0xc4, 0x78, 0x44, 0xb9, 0x63, 0x0c,
+  0x3c, 0xfb, 0xa1, 0x41, 0x11, 0x6b, 0x2d, 0x34, 0xca, 0xdb, 0x51, 0x0f,
+  0x0e, 0x40, 0xb2, 0x13, 0x20, 0x86, 0xbe, 0x1e, 0x9f, 0x15, 0x2a, 0xb4,
+  0x73, 0xbb, 0x16, 0x47, 0xb3, 0x09, 0x67, 0x56, 0x25, 0x33, 0x8d, 0x0a,
+  0x35, 0x54, 0x43, 0x68, 0xcc, 0x58, 0x9e, 0xb7, 0x9a, 0x38, 0x01, 0x55,
+  0xe7, 0xbb, 0x6f, 0xec, 0x9b, 0x4d, 0x32, 0x7c, 0x64, 0xd4, 0xc4, 0x46,
+  0xc8, 0x34, 0x01, 0x16, 0x7f, 0x70, 0x10, 0x9d, 0xec, 0x7a, 0xea, 0x35,
+  0xed, 0xf4, 0x7f, 0x17, 0x28, 0x32, 0xdc, 0xa3, 0x60, 0x0c
+};
+
+CONST UINTN  mSizeOfHedgehogMicrosoftUefiCa = sizeof mHedgehogMicrosoftUefiCa;
+
+
 //
 // The Microsoft.UefiSecureBootLogo.Tests.OutOfBoxConfirmDBXisPresent test case
 // of the Secure Boot Logo Test in the Microsoft Hardware Certification Kit
diff --git a/OvmfPkg/EnrollDefaultKeys/EnrollDefaultKeys.c b/OvmfPkg/EnrollDefaultKeys/EnrollDefaultKeys.c
index 88b6bafee8..1d7a99ef1c 100644
--- a/OvmfPkg/EnrollDefaultKeys/EnrollDefaultKeys.c
+++ b/OvmfPkg/EnrollDefaultKeys/EnrollDefaultKeys.c
@@ -702,6 +702,9 @@ ShellAppMain (
                mMicrosoftUefiCa,
                mSizeOfMicrosoftUefiCa,
                &gMicrosoftVendorGuid,
+               mHedgehogMicrosoftUefiCa,
+               mSizeOfHedgehogMicrosoftUefiCa,
+               &gMicrosoftVendorGuid,
                NULL
                );
   }
diff --git a/OvmfPkg/EnrollDefaultKeys/EnrollDefaultKeys.h b/OvmfPkg/EnrollDefaultKeys/EnrollDefaultKeys.h
index 56da9c71d6..57724d6c5b 100644
--- a/OvmfPkg/EnrollDefaultKeys/EnrollDefaultKeys.h
+++ b/OvmfPkg/EnrollDefaultKeys/EnrollDefaultKeys.h
@@ -130,6 +130,9 @@ extern CONST UINTN  mSizeOfMicrosoftPca;
 extern CONST UINT8  mMicrosoftUefiCa[];
 extern CONST UINTN  mSizeOfMicrosoftUefiCa;
 
+extern CONST UINT8  mHedgehogMicrosoftUefiCa[];
+extern CONST UINTN  mSizeOfHedgehogMicrosoftUefiCa;
+
 extern CONST UINT8  mSha256OfDevNull[];
 extern CONST UINTN  mSizeOfSha256OfDevNull;
 
diff --git a/OvmfPkg/build.sh b/OvmfPkg/build.sh
index b0334fb76e..0caf600664 100755
--- a/OvmfPkg/build.sh
+++ b/OvmfPkg/build.sh
@@ -249,7 +249,7 @@ fi
 # Build the edk2 OvmfPkg
 #
 echo Running edk2 build for OvmfPkg$Processor
-build -p $PLATFORMFILE $BUILD_OPTIONS -b $BUILDTARGET -t $TARGET_TOOLS -n $THREADNUMBER -DDEBUG_ON_SERIAL_PORT=TRUE
+build -p $PLATFORMFILE $BUILD_OPTIONS -b $BUILDTARGET -t $TARGET_TOOLS -n $THREADNUMBER
 
 if [[ "$RUN_QEMU" == "yes" ]]; then
   if [[ ! -d $QEMU_FIRMWARE_DIR ]]; then

```
